<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Editor</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/common.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/rust.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" id="highlight-light-theme">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" id="highlight-dark-theme">
    
    <!-- 早期文件关联监听器 -->
    <script>
        // 设置全局文件关联标志
        window.hasFileAssociationContent = false;
        
        // 早期文件关联监听器
        function setupEarlyFileAssociationListener() {
            if (window.__TAURI__) {
                console.log('设置早期文件关联监听器');
                window.__TAURI__.event.listen('open-file', (event) => {
                    console.log('早期监听器收到文件关联事件:', event.payload);
                    window.hasFileAssociationContent = true;
                    console.log('早期监听器设置文件关联标志');
                });
            } else {
                console.log('Tauri API不可用，等待加载...');
                setTimeout(setupEarlyFileAssociationListener, 50);
            }
        }
        
        // 立即尝试设置监听器
        setupEarlyFileAssociationListener();
    </script>
    
    <script>
        // 等待highlight.js加载完成后注册语言
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof hljs !== 'undefined') {
                console.log('highlight.js已加载，注册语言支持');
                
                // 手动注册语言（如果自动注册失败）
                if (hljs.registerLanguage) {
                    console.log('使用registerLanguage注册语言');
                } else {
                    console.log('highlight.js语言已自动注册');
                }
                
                // 检查支持的语言
                console.log('支持的语言数量:', Object.keys(hljs.listLanguages()).length);
                console.log('支持的语言:', hljs.listLanguages());
            } else {
                console.error('highlight.js未加载');
            }
        });
    </script>
    
    <!-- Mermaid for flowcharts -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
</head>
<body>
    <div id="app">
        <div class="toolbar">
            <div class="toolbar-section toolbar-left">
                <div class="toolbar-group">
                    <div class="dropdown">
                        <button id="new-btn" class="btn btn-primary dropdown-toggle" title="新建文档 (Ctrl+N)">
                            <span class="icon">📄</span>
                            新建
                            <span class="dropdown-arrow">▼</span>
                        </button>
                        <div class="dropdown-menu">
                            <button id="new-blank" class="dropdown-item">
                                <span class="icon">📄</span>
                                创建空白文档
                            </button>
                            <button id="new-template" class="dropdown-item">
                                <span class="icon">📋</span>
                                使用默认模板
                            </button>
                        </div>
                    </div>
                    <button id="open-btn" class="btn" title="打开文件 (Ctrl+O)">
                        <span class="icon">📂</span>
                        打开
                    </button>
                    <button id="save-btn" class="btn" title="保存文件 (Ctrl+S)">
                        <span class="icon">💾</span>
                        保存
                    </button>
                    <button id="save-as-btn" class="btn" title="另存为 (Ctrl+Shift+S)">
                        <span class="icon">📁</span>
                        另存为
                    </button>
                </div>
            </div>
            
            <div class="toolbar-section toolbar-center">
                <div class="toolbar-group">
                    <!-- 撤销重做功能已移除 -->
                </div>
            </div>
            
            <div class="toolbar-section toolbar-right">
                <div class="toolbar-group">
                    <button id="sync-btn" class="btn btn-sync" title="同步滚动 (Ctrl+Shift+S)">
                        <span class="icon">🔗</span>
                        <span class="btn-text">同步</span>
                    </button>
                    <button id="export-btn" class="btn" title="导出为HTML">
                        <span class="icon">📤</span>
                        导出
                    </button>
                    <button id="fullscreen-btn" class="btn" title="全屏预览 (F11)">
                        <span class="icon">⛶</span>
                        全屏
                    </button>
                    <div class="theme-selector">
                        <select id="theme-select">
                            <option value="light">浅色</option>
                            <option value="dark">深色</option>
                            <option value="auto">自动</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
        
        <main class="main-content">
            <div class="editor-container">
                <textarea 
                    id="markdown-editor" 
                    placeholder="开始编写你的 Markdown 内容..."
                    spellcheck="false"
                ></textarea>
            </div>
            <div class="preview-container">
                <div id="markdown-preview"></div>
            </div>
        </main>
    </div>
    
    <!-- 调试面板 -->
    <div id="debug-panel" style="position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; max-width: 300px; z-index: 9999; display: none;">
        <div id="debug-content"></div>
        <button onclick="document.getElementById('debug-panel').style.display='none'" style="margin-top: 5px; padding: 2px 5px;">关闭</button>
    </div>
    
    <!-- 调试按钮 (Release版本备用) -->
    <div id="debug-toggle" style="position: fixed; top: 10px; right: 10px; z-index: 9998;">
        <button onclick="toggleDebugPanel()" style="background: #4CAF50; color: white; border: none; padding: 8px 12px; cursor: pointer; border-radius: 4px; font-size: 12px;">调试</button>
    </div>
    
    <script src="main.js"></script>
</body>
</html>